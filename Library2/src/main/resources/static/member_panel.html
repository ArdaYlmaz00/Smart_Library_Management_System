<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>KÃ¼tÃ¼phane | Ãœye Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding-top: 80px; }
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .book-card {
            border: none;
            border-radius: 15px;
            background: white;
            transition: 0.3s;
            height: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .book-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        .book-img-container {
            height: 280px;
            background-color: #f1f3f5;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
        }
        .book-img-top {
            max-height: 100%;
            max-width: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .badge-stock { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; color: white; font-size: 0.8rem; z-index: 2; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="#"><i class="fas fa-book me-2"></i>KÃ¼tÃ¼phane</a>
        <div class="d-flex align-items-center">
            <span class="me-3 fw-bold text-muted" id="welcomeMsg"></span>
            <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-center mb-5">
        <div class="btn-group shadow-sm rounded-pill">
            <button class="btn btn-light active px-4 rounded-pill-start" onclick="showSection('browse')" id="btn-browse">ðŸ“š Kitaplar</button>
            <button class="btn btn-light px-4" onclick="showSection('mybooks')" id="btn-mybooks">ðŸ”– KitaplarÄ±m</button>
            <button class="btn btn-light px-4 rounded-pill-end" onclick="showSection('profile')" id="btn-profile">ðŸ”’ Åžifre Ä°ÅŸlemleri</button>
        </div>
    </div>

    <div id="section-browse">
        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control form-control-lg rounded-pill border-0 shadow-sm" placeholder="Kitap ara..." onkeyup="filterBooks()">
            </div>
        </div>
        <div class="row g-4" id="bookGrid"></div>
    </div>

    <div id="section-mybooks" style="display: none;">
        <div class="card border-0 shadow-sm p-4">
            <h4 class="mb-4 text-primary">Ã–dÃ¼nÃ§ AldÄ±klarÄ±m</h4>
            <table class="table table-hover align-middle">
                <thead><tr><th>Kitap</th><th>Tarih</th><th>Durum</th></tr></thead>
                <tbody id="myLoansTable"></tbody>
            </table>
        </div>
    </div>

    <div id="section-profile" style="display: none;">
        <div class="card border-0 shadow-sm p-4 mx-auto" style="max-width: 500px;">
            <h4 class="text-center mb-4">Åžifre DeÄŸiÅŸtir</h4>
            <form onsubmit="event.preventDefault(); updatePassword();">
                <div class="mb-3"><label class="small text-muted">Yeni Åžifre</label><input type="password" id="newPass" class="form-control" required></div>
                <div class="mb-3"><label class="small text-muted">Yeni Åžifre (Tekrar)</label><input type="password" id="confirmPass" class="form-control" required></div>
                <hr>
                <div class="mb-3"><label class="small text-danger">Eski Åžifre (Onay)</label><input type="password" id="oldPass" class="form-control" required></div>
                <button type="submit" class="btn btn-primary w-100 mt-2">GÃ¼ncelle</button>
            </form>
        </div>
    </div>
</div>

<script>
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) window.location.href = 'index.html';
    document.getElementById('welcomeMsg').innerText = currentUser.firstName + " " + currentUser.lastName;
    let allBooks = [];
    document.addEventListener('DOMContentLoaded', loadBooks);

    function logout() {
        if(currentUser && currentUser.id) {
            fetch('/api/members/logout/' + currentUser.id, { method: 'POST' })
                .finally(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                });
        } else {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    }

    function showSection(sec) {
        ['browse', 'mybooks', 'profile'].forEach(s => document.getElementById('section-' + s).style.display = 'none');
        document.querySelectorAll('.btn-group .btn').forEach(btn => { btn.classList.remove('btn-primary', 'text-white'); btn.classList.add('btn-light'); });
        document.getElementById('section-' + sec).style.display = 'block';
        const activeBtn = document.getElementById('btn-' + sec);
        activeBtn.classList.remove('btn-light'); activeBtn.classList.add('btn-primary', 'text-white');
        if(sec === 'mybooks') loadMyLoans();
    }

    function loadBooks() {
        fetch('/api/books').then(res => res.json()).then(data => { allBooks = data; renderBooks(data); });
    }

    function renderBooks(books) {
        const grid = document.getElementById('bookGrid');
        grid.innerHTML = '';
        books.forEach(book => {
            const img = book.imageUrl ? book.imageUrl : 'https://via.placeholder.com/300x400?text=Resim+Yok';
            const hasStock = book.stockQuantity > 0;

            grid.innerHTML += `
                <div class="col-md-3 d-flex align-items-stretch">
                    <div class="card book-card w-100">
                        <div class="book-img-container">
                            <span class="badge-stock ${hasStock ? 'bg-success' : 'bg-danger'}">${hasStock ? 'Stok: ' + book.stockQuantity : 'TÃ¼kendi'}</span>
                            <img src="${img}" class="book-img-top">
                        </div>
                        <div class="card-body text-center d-flex flex-column">
                            <h6 class="fw-bold mb-1 text-truncate">${book.title}</h6>
                            <p class="small text-muted mb-3">${book.pageCount} Sayfa</p>
                            <button class="btn btn-primary w-100 rounded-pill mt-auto"
                                onclick="borrowBook(${book.id})" ${!hasStock ? 'disabled' : ''}>
                                ${hasStock ? 'Ã–dÃ¼nÃ§ Al' : 'Stok Yok'}
                            </button>
                        </div>
                    </div>
                </div>`;
        });
    }

    function filterBooks() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        renderBooks(allBooks.filter(b => b.title.toLowerCase().includes(val)));
    }

    function borrowBook(id) {
        if(confirm("KitabÄ± Ã¶dÃ¼nÃ§ almak istiyor musun?")) {
            fetch(`/api/loans/loan/${id}/${currentUser.id}`, {method:'POST'}).then(async res => {
                if(res.ok) { alert("Kitap baÅŸarÄ±yla alÄ±ndÄ±!"); loadBooks(); }
                else { const errorMsg = await res.text(); alert("HATA: " + (errorMsg || "Bir sorun oluÅŸtu.")); }
            });
        }
    }

    function loadMyLoans() {
        if (!currentUser) return;

        fetch('/api/loans/member/' + currentUser.id)
            .then(response => response.json())
            .then(loans => {
                const tbody = document.getElementById('myLoansTable');
                tbody.innerHTML = '';

                loans.forEach(loan => {
                    let statusHtml = '';
                    let payButtonHtml = '';

                    if (loan.fineAmount > 0) {
                        statusHtml = `<span class="badge bg-danger">Ceza: ${loan.fineAmount} TL</span>`;
                        payButtonHtml = `<button class="btn btn-success btn-sm ms-2" onclick="payFine(${loan.id})">
                                            <i class="fas fa-credit-card"></i> Ã–DE
                                         </button>`;
                    } else {
                        statusHtml = `<span class="badge bg-success">ZamanÄ± Var</span>`;
                    }

                    let returnButtonHtml = `<button class="btn btn-warning btn-sm text-white" onclick="returnBook(${loan.id})">
                                                <i class="fas fa-undo"></i> Ä°ade Et
                                            </button>`;

                    const imgUrl = loan.book.imageUrl || 'https://via.placeholder.com/40x60';

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${imgUrl}" style="width: 40px; height: 60px; object-fit: cover; margin-right: 10px; border-radius: 4px;">
                                    <span class="fw-bold">${loan.book.title}</span>
                                </div>
                            </td>
                            <td>${loan.loanDate}</td>
                            <td>${statusHtml}</td> <td>
                                ${returnButtonHtml}
                                ${payButtonHtml}
                            </td> </tr>
                    `;
                });
            })
            .catch(err => console.error("Hata:", err));
    }

    function returnBook(loanId) {
        if(confirm("KitabÄ± iade etmek istiyor musunuz?")) {
            fetch('/api/loans/return/' + loanId, { method: 'POST' })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    loadMyLoans(); // Tabloyu yenile
                });
        }
    }

    function payFine(loanId) {
        if(confirm("GÃ¼ncel ceza tutarÄ±nÄ± Ã¶demek ve kitabÄ± iade etmek istiyor musunuz?")) {
            fetch('/api/loans/pay-fine/' + loanId, { method: 'PUT' })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    loadMyLoans();
                })
                .catch(error => {
                    console.error('Hata:', error);
                    alert("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu.");
                });
        }
    }

    function updatePassword() {
        const newPass = document.getElementById('newPass').value;
        const confirmPass = document.getElementById('confirmPass').value;
        const oldPass = document.getElementById('oldPass').value;
        if(newPass !== confirmPass) { alert("HATA: Yeni ÅŸifreler uyuÅŸmuyor!"); return; }
        fetch(`/api/members/change-password/${currentUser.id}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ newPass: newPass, confirmPass: confirmPass, oldPass: oldPass })
        }).then(async res => { alert(await res.text()); if(res.ok) logout(); });
    }
</script>
</body>
</html>